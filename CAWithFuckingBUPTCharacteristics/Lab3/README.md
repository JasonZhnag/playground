# Lab 3

（1）自行编写一个计算两个向量点积的汇编程序，该程序要求可以实现求两个向量点
积计算后的结果。

向量的点积：假设有两个 n 维向量 a、b，则 a 与 b 的点积为：

$$a · b = \sum(a_i * b_i)$$

两个向量元素使用数组进行数据存储，要求向量的维度不得小于 10

```
.text
main:
ADDIU  $r4,$r0,a
ADDIU  $r5,$r0,b
ADDIU  $r6,$r0,n
BGEZAL  $r0, naive_prod
NOP 
TEQ $r0,$r0

naive_prod:
LW     $r6, 0($r6)
ADD    $r8, $r0, $r0
ADD    $r2, $r0, $r0
loop:
LW     $r9, 0($r4)
LW     $r10, 0($r5)
MUL    $r11, $r9, $r10
ADD    $r2, $r2, $r11
ADDIU  $r4, $r4, 4
ADDIU  $r5, $r5, 4
ADDIU  $r8, $r8, 1
BNE    $r8, $r6, loop
JR     $r31

.data
a: 
.word 1,2,3,4,5,6,7,8,9,10,11
b:
.word 1,2,3,4,5,6,7,8,9,10,11
n:
.word 11
```

（2）启动 MIPSsim。
（3）载入自己编写的程序，观察流水线输出结果。

```
  汇总：
    执行周期总数：178
    ID段执行了98条指令

  硬件配置：
    内存容量：4096 B
    加法器个数：1		执行时间（周期数）：6
    乘法器个数：1		执行时间（周期数）7		
    除法器个数：1		执行时间（周期数）10		
    定向机制：不采用

  停顿（周期数）：
    RAW停顿：66		占周期总数的百分比：37.07865%
    其中：
      load停顿：22		占所有RAW停顿的百分比：33.33333%
      浮点停顿：0		占所有RAW停顿的百分比：0%
    WAW停顿：0		占周期总数的百分比：0%
    结构停顿：0		占周期总数的百分比：0%
    控制停顿：13		占周期总数的百分比：7.303371%
    自陷停顿：0		占周期总数的百分比：0%
    停顿周期总数：79	占周期总数的百分比：44.38202%

  分支指令：
    指令条数：12		占指令总数的百分比：12.2449%
    其中：
      分支成功：12		占分支指令数的百分比：100%
      分支失败：1		占分支指令数的百分比：8.333333%

  load/store指令：
    指令条数：24		占指令总数的百分比：24.4898%
    其中：
      load：24		占load/store指令数的百分比：100%
      store：0		占load/store指令数的百分比：0%

  浮点指令：
    指令条数：0		占指令总数的百分比：0%
    其中：
      加法：0		占浮点指令数的百分比：0%
      乘法：0		占浮点指令数的百分比：0%
      除法：0		占浮点指令数的百分比：0%

  自陷指令：
    指令条数：1		占指令总数的百分比：1.020408%
```

（4）使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。

> 178 / 134 = 1.32

```
  汇总：
    执行周期总数：134
    ID段执行了98条指令

  硬件配置：
    内存容量：4096 B
    加法器个数：1		执行时间（周期数）：6
    乘法器个数：1		执行时间（周期数）7		
    除法器个数：1		执行时间（周期数）10		
    定向机制：采用

  停顿（周期数）：
    RAW停顿：22		占周期总数的百分比：16.41791%
    其中：
      load停顿：11		占所有RAW停顿的百分比：50%
      浮点停顿：0		占所有RAW停顿的百分比：0%
    WAW停顿：0		占周期总数的百分比：0%
    结构停顿：0		占周期总数的百分比：0%
    控制停顿：13		占周期总数的百分比：9.701492%
    自陷停顿：0		占周期总数的百分比：0%
    停顿周期总数：35	占周期总数的百分比：26.1194%

  分支指令：
    指令条数：12		占指令总数的百分比：12.2449%
    其中：
      分支成功：12		占分支指令数的百分比：100%
      分支失败：1		占分支指令数的百分比：8.333333%

  load/store指令：
    指令条数：24		占指令总数的百分比：24.4898%
    其中：
      load：24		占load/store指令数的百分比：100%
      store：0		占load/store指令数的百分比：0%

  浮点指令：
    指令条数：0		占指令总数的百分比：0%
    其中：
      加法：0		占浮点指令数的百分比：0%
      乘法：0		占浮点指令数的百分比：0%
      除法：0		占浮点指令数的百分比：0%

  自陷指令：
    指令条数：1		占指令总数的百分比：1.020408%
```

（5）采用静态调度方法重排指令序列，减少相关，优化程序

```
.text
main:
ADDIU  $r4,$r0,a
ADDIU  $r5,$r0,b
ADDIU  $r6,$r0,n
BGEZAL  $r0, naive_prod
NOP 
TEQ $r0,$r0

naive_prod:
LW     $r6, 0($r6)
ADD    $r8, $r0, $r0
ADD    $r2, $r0, $r0
loop:
LW     $r9, 0($r4)
LW     $r10, 0($r5)
ADDIU  $r4, $r4, 4
ADDIU  $r5, $r5, 4
MUL    $r11, $r9, $r10
ADDIU  $r8, $r8, 1
ADD    $r2, $r2, $r11
BNE    $r8, $r6, loop
JR     $r31

.data
a: 
.word 1,2,3,4,5,6,7,8,9,10,11
b:
.word 1,2,3,4,5,6,7,8,9,10,11
n:
.word 11
```

（6）对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的
不同。

> 134 / 112 = 1.19

> 当然还可以做循环展开再干掉几个控制停顿，但是俺懒得写

```
  汇总：
    执行周期总数：112
    ID段执行了98条指令

  硬件配置：
    内存容量：4096 B
    加法器个数：1		执行时间（周期数）：6
    乘法器个数：1		执行时间（周期数）7		
    除法器个数：1		执行时间（周期数）10		
    定向机制：采用

  停顿（周期数）：
    RAW停顿：0		占周期总数的百分比：0%
    其中：
      load停顿：0		占所有RAW停顿的百分比：0%
      浮点停顿：0		占所有RAW停顿的百分比：0%
    WAW停顿：0		占周期总数的百分比：0%
    结构停顿：0		占周期总数的百分比：0%
    控制停顿：13		占周期总数的百分比：11.60714%
    自陷停顿：0		占周期总数的百分比：0%
    停顿周期总数：13	占周期总数的百分比：11.60714%

  分支指令：
    指令条数：12		占指令总数的百分比：12.2449%
    其中：
      分支成功：12		占分支指令数的百分比：100%
      分支失败：1		占分支指令数的百分比：8.333333%

  load/store指令：
    指令条数：24		占指令总数的百分比：24.4898%
    其中：
      load：24		占load/store指令数的百分比：100%
      store：0		占load/store指令数的百分比：0%

  浮点指令：
    指令条数：0		占指令总数的百分比：0%
    其中：
      加法：0		占浮点指令数的百分比：0%
      乘法：0		占浮点指令数的百分比：0%
      除法：0		占浮点指令数的百分比：0%

  自陷指令：
    指令条数：1		占指令总数的百分比：1.020408%
```